GUIA DE RECUPERACION: INTEGRACION DESMOS
==========================================

Si alguna vez necesitas restaurar la funcionalidad de Desmos, sigue estos pasos.
Este archivo está en formato de texto plano para que puedas copiar y pegar sin perder formato.

PASO 1: EL ARCHIVO DEL COMPONENTE
---------------------------------
Crea un archivo llamado "DesmosGraph.tsx" dentro de la carpeta "components".
Copia EXACTAMENTE el siguiente bloque de código (desde IMPORT hasta el final):

import React, { useEffect, useRef, useState } from 'react';
import { RegressionRow } from '../types';

declare global {
    interface Window {
        Desmos: any;
    }
}

interface DesmosGraphProps {
    data: RegressionRow[];
    regressionParams?: { m: number; b: number; r2: number };
    onExport?: (imageBase64: string) => void;
    height?: string;
    className?: string;
}

export const DesmosGraph: React.FC<DesmosGraphProps> = ({
    data,
    regressionParams,
    onExport,
    height = "500px",
    className = ""
}) => {
    const containerRef = useRef<HTMLDivElement>(null);
    const calculatorRef = useRef<any>(null);
    const [isReady, setIsReady] = useState(false);
    const [showExportModal, setShowExportModal] = useState(false);
    const [exportConfig, setExportConfig] = useState({ size: 'medium', thickness: 'medium' });

    useEffect(() => {
        if (!containerRef.current || !window.Desmos || calculatorRef.current) return;
        const elt = containerRef.current;
        const calculator = window.Desmos.GraphingCalculator(elt, {
            expressions: true,
            settingsMenu: true,
            zoomButtons: true,
            lockViewport: false,
            expressionsCollapsed: false,
            images: true,
            folders: true,
            notes: true,
            links: true,
            keypad: true,
            graphpaper: true,
            projectorMode: false,
            pasteGraphLink: true
        });
        calculatorRef.current = calculator;
        calculator.updateSettings({ expressionsCollapsed: false, keypad: true });
        setIsReady(true);
        return () => { calculator.destroy(); calculatorRef.current = null; };
    }, []);

    useEffect(() => {
        if (!calculatorRef.current || !isReady) return;
        const calculator = calculatorRef.current;
        const formatScientific = (num: number, precision: number) => {
            const str = num.toExponential(precision);
            const [base, exp] = str.split('e');
            const cleanExp = exp ? exp.replace('+', '') : '';
            return `${base} \\cdot 10^{${cleanExp}}`;
        };
        const columns = [
            { latex: 'x_1', values: data.map(d => formatScientific(d.x, 4)) },
            { latex: 'y_1', values: data.map(d => formatScientific(d.y, 4)) }
        ];
        calculator.setExpression({ id: 'data_table', type: 'table', columns: columns });
        if (regressionParams) {
            const { m, b } = regressionParams;
            const mStr = formatScientific(m, 6);
            const bStr = formatScientific(Math.abs(b), 6);
            const sign = b >= 0 ? '+' : '-';
            calculator.setExpression({
                id: 'regression_line',
                latex: `y = ${mStr}x ${sign} ${bStr}`,
                color: '#c74440',
                lineStyle: window.Desmos.Styles.SOLID
            });
        } else {
            calculator.removeExpression({ id: 'regression_line' });
        }
    }, [data, regressionParams, isReady]);

    const handleScreenshot = () => {
        if (!calculatorRef.current || !onExport) return;
        const calculator = calculatorRef.current;
        let width = 800; let height = 600; let pixelRatio = 1;
        switch (exportConfig.size) {
            case 'small': width = 400; height = 300; break;
            case 'medium': width = 800; height = 600; break;
            case 'large': width = 1920; height = 1080; break;
        }
        switch (exportConfig.thickness) {
            case 'thin': pixelRatio = 2; break;
            case 'medium': pixelRatio = 1.5; break;
            case 'thick': pixelRatio = 1; break;
        }
        const screenshot = calculator.screenshot({ width, height, targetPixelRatio: pixelRatio });
        onExport(screenshot);
        setShowExportModal(false);
    };

    return (
        <div className={`flex flex-col relative ${className}`}>
            <div className="bg-slate-900 text-white p-3 rounded-t-[1.5rem] flex justify-between items-center px-6 shadow-md z-10">
                <span className="font-bold text-sm tracking-widest uppercase flex items-center gap-2">
                    <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Calculadora Gráfica
                </span>
                <div className="flex gap-2">
                    <button onClick={() => setShowExportModal(true)} className="flex items-center gap-2 bg-[#004b87] hover:bg-blue-600 px-4 py-1.5 rounded-lg text-xs font-bold transition-all shadow-lg border border-white/10">
                        Exportar Imagen
                    </button>
                </div>
            </div>
            <div ref={containerRef} style={{ width: '100%', height: height }} className="border-x-4 border-b-4 border-slate-900 rounded-b-[2rem] overflow-hidden bg-white relative" />
            {showExportModal && (
                <div className="absolute inset-0 z-[100] flex items-center justify-center bg-slate-900/80 rounded-[2rem] backdrop-blur-sm">
                    <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 space-y-6 text-slate-800 border-2 border-slate-100">
                        <h3 className="font-black text-xl text-[#004b87]">Exportar Gráfica</h3>
                        <div className="space-y-4">
                            <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Tamaño</label><select value={exportConfig.size} onChange={(e) => setExportConfig({ ...exportConfig, size: e.target.value })} className="w-full p-2 border rounded"><option value="small">Pequeño</option><option value="medium">Mediano</option><option value="large">Grande</option></select></div>
                            <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Grosor</label><div className="flex gap-1">{['thin', 'medium', 'thick'].map((t) => (<button key={t} onClick={() => setExportConfig({ ...exportConfig, thickness: t })} className={`flex-1 py-2 text-xs font-bold rounded ${exportConfig.thickness === t ? 'bg-blue-100 text-blue-800' : 'bg-slate-100'}`}>{t}</button>))}</div></div>
                        </div>
                        <button onClick={handleScreenshot} className="w-full py-3 bg-[#004b87] text-white rounded-xl font-bold uppercase text-xs">Capturar</button>
                        <button onClick={() => setShowExportModal(false)} className="w-full py-2 text-slate-400 text-xs hover:text-red-500">Cancelar</button>
                    </div>
                </div>
            )}
        </div>
    );
};


PASO 2: INTEGRACION EN App.tsx
------------------------------
En tu archivo App.tsx, en la sección donde renderizas el paso "FormStep.Analysis", pega esto:

<DesmosGraph 
    data={getRegressionData(activeSeries)}
    regressionParams={calculateStats(getRegressionData(activeSeries)) || undefined}
    onExport={(base64) => updateReport({ graphImageUrl: base64 })}
    height="800px" 
/>

Asegúrate de importar el componente al principio del archivo:
import { DesmosGraph } from './components/DesmosGraph';
